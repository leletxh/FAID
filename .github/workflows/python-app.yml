name: Python application

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_deploy:

    runs-on: windows-latest

    env:
      Nuitka_OPTIONS: "--onefile --standalone --include-module=gradio,json,requests --include-package=PIL.ImageQt --output-filename=app.exe app.py --assume-yes-for-downloads --show-progress --jobs=3"
      APP_BRANCH: "app"

    steps:
    - name: 创建python3.10
      uses: actions/checkout@v4
    - name: 启动环境
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: 安装依赖
      run: |
        ping 127.0.0.1
    - name: 构建
      run: |
        ping 127.0.0.1
    - name: 重命名并移动文件
      id: rename-and-move
      shell: pwsh
      run: |
        $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
        $newFileName = "$timestamp_FAID.py"
        $originalFilePath = "app.py"
        $newFilePath = Join-Path -Path "." -ChildPath $newFileName
        Move-Item -Path $originalFilePath -Destination $newFilePath
        Write-Output "File has been renamed to: $newFilePath"
        
        # Ensure the 'apps' directory exists
        if (-Not (Test-Path -Path "apps")) {
            mkdir apps
            Move-Item -Path $newFilePath -Destination "apps/$newFileName"
        }

        # Check if the destination file already exists and delete it
        if (Test-Path -Path "apps/$newFileName") {
            Remove-Item -Path "apps/$newFileName" -Force
        }

        Write-Output "File has been moved to: apps/$newFileName"
        echo "::set-output name=newFileName::$newFileName"
    - name: 提交并推送更改
      shell: pwsh
      env:
        ACTION_TOKEN: ${{ secrets.ACTION_TOKEN }}
        NEW_FILE_NAME: ${{ steps.rename-and-move.outputs.newFileName }}
      run: |
        $newFileName = "${{ env.NEW_FILE_NAME }}"
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git checkout main || git checkout -b main
        git add apps/$newFileName
        git commit -m "Add new build: $newFileName" || echo "No changes to commit"
        git push https://$ACTION_TOKEN@github.com/${{ github.repository }}.git main
